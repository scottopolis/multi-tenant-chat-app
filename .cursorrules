# Multi-Tenant Chat Assistant - Development Rules

## Project Overview

This is a multi-tenant chat assistant platform with:
- **Backend**: Cloudflare Worker (Hono + AI SDK + OpenRouter)
- **Frontend**: React widget (Vite + TanStack Query + shadcn/ui)
- **AI Provider**: OpenRouter for flexible LLM model selection
- **Testing**: Vitest (unit) + Playwright (E2E)

## Architecture Principles

1. **Minimal MVP Focus**: Keep implementation simple and focused on core features
2. **Streaming First**: Use SSE for real-time chat responses
3. **Tool-Capable Agents**: Support function calling via AI SDK
4. **Type Safety**: Use TypeScript strictly across all code
5. **Multi-Tenancy Ready**: Design for org-level isolation (auth TBD)

## Code Style & Standards

### General
- Use TypeScript with strict mode enabled
- Prefer functional programming patterns
- Use async/await over promises chains
- Add JSDoc comments for public APIs and complex logic
- Keep functions small and focused (< 50 lines ideally)

### Backend (Worker)
- Use Hono for routing and middleware
- Follow RESTful API conventions
- Return proper HTTP status codes
- Use Zod for request validation
- Handle errors gracefully with try/catch
- Log errors with `console.error` for debugging

### Frontend (Widget)
- Use React functional components with hooks
- Use TanStack Query for data fetching
- Use shadcn/ui components for UI consistency
- Follow Tailwind CSS utility-first approach
- Keep components small and reusable
- Use TypeScript interfaces for props

### Testing
- **Prefer E2E tests** for critical user journeys
- Only write unit tests for complex business logic
- Test focus: happy paths, not exhaustive coverage
- Avoid tests with heavy mocking or trivial assertions
- Use real APIs in E2E tests with worker running

## File Organization

```
worker/
  src/
    agents/       # LLM agent configuration and execution
    tools/        # Function/tool definitions for agents
    index.ts      # Main worker entry point
    storage.ts    # Data storage (in-memory for now)

widget/
  src/
    components/   # React components
    hooks/        # Custom React hooks
    lib/          # Utilities (API client, utils)
    e2e/          # Playwright E2E tests
```

## Key Patterns

### Agent Configuration
- Use OpenRouter for model access (not direct OpenAI)
- Configure available models in `worker/src/agents/index.ts`
- Default model: `gpt-4.1-mini` (fast and affordable)
- Support model selection per request

### Tool Calling
- Define tools in `worker/src/tools/`
- Use AI SDK tool format
- Built-in tools: calculator, getCurrentTime, randomNumber
- Webhook tool for custom integrations

### API Patterns
- POST `/api/chats?agent=<id>` - Create new chat (agent routing)
- GET `/api/chats?agent=<id>` - List chats
- GET `/api/chats/:chatId?agent=<id>` - Get chat with messages
- POST `/api/chats/:chatId/messages?agent=<id>` - Send message (SSE response)
- GET `/api/models` - List available models

**Agent Routing (Phase 0 - MVP):**
- All endpoints accept `?agent=<id>` query parameter
- Agent ID maps to `orgId` internally (tenant isolation)
- Defaults to `agent=default` if not specified
- Examples: `?agent=tenant-1`, `?agent=acme-support`

### Environment Variables
- `OPENROUTER_API_KEY` - Required for worker (not `OPENAI_API_KEY`)
- `VITE_API_URL` - Widget API endpoint (default: `http://localhost:8787`)
- `VITE_AGENT_ID` - Widget agent ID (default: `default`)

## TODOs & Future Work

Current implementation has placeholder TODOs for:
- Authentication (JWT-based, per-org)
- Persistent storage (D1 or KV)
- Langfuse integration (prompt management + tracing)
- CORS restrictions per org
- Org-specific model configuration
- Rate limiting

## Common Tasks

### Adding a New Tool
1. Define tool in `worker/src/tools/builtin.ts` or create new file
2. Export from `worker/src/tools/index.ts`
3. Test with a chat message that should trigger it

### Adding a New Model
1. Add to `AVAILABLE_MODELS` in `worker/src/agents/index.ts`
2. Update `/api/models` endpoint in `worker/src/index.ts`
3. Ensure model is available via OpenRouter

### Modifying UI Components
1. Update component in `widget/src/components/`
2. Maintain shadcn/ui styling patterns
3. Test with `npm run dev` in widget directory
4. Add E2E test if it's a critical flow

## Testing Guidelines

**Philosophy: Prefer E2E tests over unit tests**

### Unit Tests (Vitest)
- **Only write for complex business logic** (e.g., multi-tenant isolation, data transformations)
- Avoid testing trivial code or code with heavy mocking
- Keep tests focused on critical edge cases
- Keep tests fast (< 100ms per test)
- Run: `cd worker && npm test`

**Examples of what to unit test:**
- Multi-tenant chat isolation logic
- Complex data transformations
- Critical error handling paths

**Examples of what NOT to unit test:**
- Simple CRUD operations
- API endpoint routing (use E2E instead)
- UI component rendering (use E2E instead)

### E2E Tests (Playwright) - **Preferred**
- Test complete user flows end-to-end
- **Require worker running on localhost:8787**
- Focus on critical user journeys (2-5 tests per feature)
- Allow longer timeouts for API calls (10-15s)
- Use `data-*` attributes for stable selectors
- Run: `cd widget && npx playwright test`
- Run specific test: `npx playwright test agent-routing.spec.ts`

### Current E2E Test Coverage
1. `chat.spec.ts` - Full chat flow, streaming, tool usage
2. `agent-routing.spec.ts` - Agent routing and tenant isolation

### Running Tests
```bash
# Worker unit tests
cd worker && npm test

# Widget E2E tests (worker must be running)
cd worker && npm run dev  # Terminal 1
cd widget && npx playwright test  # Terminal 2

# Run specific E2E test
cd widget && npx playwright test agent-routing.spec.ts
```

## Debugging

### Worker Issues
- Check terminal running `npm run dev` in worker/
- Verify `OPENROUTER_API_KEY` in `.dev.vars`
- Check wrangler logs for errors
- Test API endpoints with curl or Postman

### Widget Issues
- Check browser console for errors
- Verify `VITE_API_URL` points to worker
- Check Network tab for failed requests
- Ensure worker is running before starting widget

### Test Failures
- Ensure worker is running on port 8787
- Check if placeholder text matches in components
- Verify timeouts are sufficient for API responses
- Look for race conditions in async operations

## Important Notes

- **Always use OpenRouter**, not direct OpenAI SDK
- **Environment variable is `OPENROUTER_API_KEY`**, not `OPENAI_API_KEY`
- **Default model is `gpt-4.1-mini`** (maps to `openai/gpt-4.1-mini` on OpenRouter)
- **Tests require worker running** on localhost:8787
- **Storage is in-memory** - data resets on worker restart
- **No authentication yet** - all requests use default org

## Best Practices

1. **Before making changes**: Read relevant files, understand existing patterns
2. **When adding features**: Keep it minimal, follow existing conventions
3. **When fixing bugs**: Add a test that reproduces the bug first
4. **When refactoring**: Ensure tests still pass
5. **When in doubt**: Check PLAN.md for architectural decisions
6. **Do NOT create summary documents** - No MCP-IMPLEMENTATION.md, SUMMARY.md, or similar files unless explicitly requested

## References

- [PLAN.md](./PLAN.md) - Detailed implementation plan
- [QUICKSTART.md](./QUICKSTART.md) - 5-minute setup guide
- [TESTING.md](./TESTING.md) - Testing guidelines
- [docs/](./docs/) - API reference and guides

